# Flutter 项目迁移计划

## 项目概述
- **项目名称**: timefly (flutter-checkio)
- **当前状态**: 使用 Dart 2.7，需要迁移到 Dart 3.x (空安全)
- **主要问题**: 
  - 代码未启用空安全
  - 多个依赖包版本过旧，不兼容 Flutter 3.x
  - 大量空安全相关编译错误

## 迁移目标
1. ✅ 升级 SDK 版本到支持空安全 (已完成: `>=2.12.0 <4.0.0`)
2. ⏳ 修复所有空安全相关错误
3. ⏳ 升级不兼容的第三方依赖
4. ⏳ 更新已废弃的 API
5. ⏳ 确保项目可以成功编译和运行

---

## 阶段一：依赖升级

### 1.1 必须升级的依赖包

| 包名 | 当前版本 | 目标版本 | 原因 |
|------|---------|---------|------|
| `flutter_svg` | 0.22.0 | >=2.0.0 | 使用已废弃的 `hashValues` API |
| `flash` | 2.0.1 | >=3.0.0 | 使用已废弃的 `primaryVariant`、`headline6` 等 API |
| `modal_bottom_sheet` | 2.0.0 | >=3.0.0 | 使用已废弃的 `VelocityTracker` 构造函数 |
| `flutter_local_notifications` | 6.0.0 | >=19.0.0 | API 变更，需要空安全支持 |
| `shared_preferences` | any | >=2.0.0 | 需要明确版本，支持空安全 |

### 1.2 操作步骤
```yaml
# 在 pubspec.yaml 中更新依赖
dependencies:
  flutter_svg: ^2.0.0
  flash: ^3.0.0
  modal_bottom_sheet: ^3.0.0
  flutter_local_notifications: ^19.0.0
  shared_preferences: ^2.0.0
```

### 1.3 执行命令
```bash
flutter pub get
flutter pub upgrade
```

---

## 阶段二：空安全迁移 - 核心模型类

### 2.1 User 模型 (`lib/models/user.dart`)

**问题**:
- `User.fromJson()` 中 `json['id']?.toString()` 可能返回 null，但构造函数需要非空 String
- `SessionUtils.currentUser` 和 `habitsBloc` 未初始化
- `logout()` 方法中 `currentUser = null` 违反空安全

**修复方案**:
```dart
// User 类构造函数改为可空参数
class User {
  final String id;
  final String username;
  final String phone;

  User(this.id, this.username, this.phone);

  static User? fromJson(Map<String, dynamic> json) {
    final id = json['id']?.toString();
    final username = json["username"]?.toString();
    final phone = json["phone"]?.toString();
    
    if (id == null || username == null || phone == null) {
      return null;
    }
    return User(id, username, phone);
  }
}

// SessionUtils 类
class SessionUtils {
  User? currentUser;  // 改为可空
  HabitsBloc? habitsBloc;  // 改为可空
  
  void logout() async {
    currentUser = null;  // 现在允许 null
    await DatabaseProvider.db.deleteUser();
    habitsBloc?.add(HabitsLoad());
  }
  
  bool isLogin() {
    return currentUser != null;
  }
  
  String? getUserId() {
    return currentUser?.id;  // 返回可空
  }
}
```

### 2.2 Habit 模型 (`lib/models/habit.dart`)

**问题**:
- `List<String>()` 构造函数已废弃，应使用 `[]` 或 `List<String>.empty()`
- `fromJson()` 中多个字段可能为 null
- `toJson()` 中重复声明 `temp` 变量

**修复方案**:
```dart
// 修复 List 构造函数
static Habit fromJson(Map<String, dynamic> json, {List<HabitRecord>? records}) {
  var remindTimes = <String>[];  // 使用字面量语法
  if (json["remindTimes"] != null) {
    var timesJson = jsonDecode(json["remindTimes"]);
    timesJson.forEach((json) {
      remindTimes.add(json.toString());
    });
  }
  var completeDays = <int>[];  // 使用字面量语法
  // ... 其他代码
}

// 修复 toJson 方法
Map<String, dynamic> toJson() {
  // ... 其他代码
  var times = remindTimes;
  var timesList = <String>[];  // 重命名变量
  times.forEach((time) {
    timesList.add(time);
  });
  data["remindTimes"] = jsonEncode(timesList);
  
  var days = completeDays;
  var daysList = <int>[];  // 重命名变量
  days.forEach((day) {
    daysList.add(day);
  });
  data["completeDays"] = jsonEncode(daysList);
  // ... 其他代码
}
```

---

## 阶段三：空安全迁移 - BLoC 相关

### 3.1 UserBloc (`lib/blocs/user_bloc.dart`)

**问题**:
- `UserLoadSuccess(null)` 违反空安全
- `_mapUserLoadState` 中 `getCurrentUser()` 可能返回 null

**修复方案**:
```dart
class UserLoadSuccess extends UserState {
  final User? user;  // 改为可空

  UserLoadSuccess(this.user);

  @override
  List<Object?> get props => [user];  // 改为 Object?
}

class UserBloc extends Bloc<UserEvent, UserState> {
  final HabitsBloc habitsBloc;

  UserBloc(this.habitsBloc) : super(UserLoadSuccess(null));  // 现在允许 null

  Stream<UserState> _mapUserLoadState(UserLoadEvent event) async* {
    User? user = await DatabaseProvider.db.getCurrentUser();
    yield UserLoadSuccess(user);
    habitsBloc.add(HabitsLoad());
  }
}
```

### 3.2 HabitsBloc (`lib/blocs/habit/habit_bloc.dart`)

**问题**:
- 使用旧的 `mapEventToState` API，应使用新的 `on<Event>` 和 `emit` API
- `Emitter` 类型未导入

**修复方案**:
```dart
import 'package:flutter_bloc/flutter_bloc.dart';

class HabitsBloc extends Bloc<HabitEvent, HabitsState> {
  HabitsBloc() : super(HabitsInitial()) {
    on<HabitsLoad>(_mapHabitsLoadToState);
    on<HabitsAdd>(_mapHabitsAddToState);
    on<HabitUpdate>(_mapHabitUpdateToState);
  }

  Future<void> _mapHabitsLoadToState(
    HabitsLoad event,
    Emitter<HabitsState> emit,
  ) async {
    // 使用 emit 而不是 yield
    emit(HabitsLoadInProgress());
    // ... 其他代码
  }

  void _mapHabitsAddToState(
    HabitsAdd event,
    Emitter<HabitsState> emit,
  ) {
    // 使用 emit
    emit(HabitsLoadSuccess([...state.habits, event.habit]));
  }

  void _mapHabitUpdateToState(
    HabitUpdate event,
    Emitter<HabitsState> emit,
  ) {
    // 使用 emit
    // ... 更新逻辑
  }
}
```

---

## 阶段四：空安全迁移 - 工具类和 Widget

### 4.1 DateUtil (`lib/utils/date_util.dart`)

**问题**:
- `totalCheck['...']` 可能返回 null
- `days.add(null)` 违反空安全

**修复方案**:
```dart
// 修复可能为 null 的访问
List<HabitRecord> records = totalCheck['${oldDay.year}-${oldDay.month}-${oldDay.day}'] ?? [];

// 修复 null 添加到 List
List<DateTime?> days = [];  // 改为可空类型
days.add(null);  // 现在允许
```

### 4.2 HabitUtil (`lib/utils/habit_util.dart`)

**问题**:
- `List<Habit>()` 构造函数已废弃
- Map 值可能为 null
- `streaks[key]` 可能为 null

**修复方案**:
```dart
// 修复 List 构造函数
map[completeTime] = <Habit>[];  // 使用字面量

// 修复 null 检查
if (map[completeTime] != null) {
  map[completeTime]!.add(habit);
}

// 修复 streaks 可能为 null
keys.sort((a, b) {
  final streakA = streaks[a] ?? 0;
  final streakB = streaks[b] ?? 0;
  return streakA == streakB ? 1 : streakB - streakA;
});

if ((streaks[key] ?? 0) >= 1) {
  newStreaks[key] = streaks[key]!;
}
```

### 4.3 Widget 修复

#### 4.3.1 CircleProgressBar (`lib/widget/circle_progress_bar.dart`)

**问题**:
- `ColorTween` 不能直接赋值给 `Tween<Color>`
- `size - Offset` 类型不匹配

**修复方案**:
```dart
// 修复 Tween 类型
Tween<Color>? backgroundColorTween;  // 改为可空
Tween<Color>? foregroundColorTween;  // 改为可空

// 在构造函数中
if (backgroundColor != null) {
  this.backgroundColorTween = ColorTween(
    begin: backgroundColor,
    end: backgroundColor,
  );
} else {
  this.backgroundColorTween = null;
}

// 修复 size 计算
final Size adjustedSize = Size(
  size.width - this.strokeWidth,
  size.height - this.strokeWidth,
);
```

#### 4.3.2 CalendarView (`lib/widget/calendar_view.dart`)

**问题**:
- `days` 未初始化
- `DateTime?` 不能赋值给 `DateTime`

**修复方案**:
```dart
class _CalendarViewState extends State<CalendarView> {
  List<DateTime> days = [];  // 初始化

  // 修复 null 赋值
  DateTime? nextDay = days.length - 1 > index ? days[index + 1] : null;
}
```

#### 4.3.3 TabIndicator (`lib/widget/tab_indicator.dart`)

**问题**:
- `configuration.size` 可能为 null

**修复方案**:
```dart
final size = configuration.size;
if (size == null) return SizedBox.shrink();

// 使用 size 而不是 configuration.size
final height = size.height;
final width = size.width;
```

---

## 阶段五：第三方库 API 更新

### 5.1 NotificationPlugin (`lib/notification/notification_plugin.dart`)

**问题**:
- `requestPermissions` 在可空对象上调用

**修复方案**:
```dart
final iOS = FlutterLocalNotificationsPlugin()
    .resolvePlatformSpecificImplementation<IOSFlutterLocalNotificationsPlugin>();
if (iOS != null) {
  await iOS.requestPermissions(alert: true, sound: true, badge: true);
}
```

### 5.2 ThemeBloc (`lib/blocs/theme/theme_bloc.dart`)

**问题**:
- `shared.getString()` 返回可空值

**修复方案**:
```dart
final themeMode = shared.getString(THEME_MODE);
if (themeMode != null) {
  getInitThemeMode(themeMode);
}

final colorMode = shared.getString(COLOR_MODE);
if (colorMode != null) {
  getInitColorMode(colorMode);
}
```

---

## 阶段六：字段初始化修复

### 6.1 需要初始化的字段

以下类需要添加 `late` 关键字或提供默认值：

1. **AppTheme** (`lib/app_theme.dart`)
   ```dart
   late AppThemeMode currentThemeMode;
   late AppThemeColorMode currentColorMode;
   late AppFontMode currentFontMode;
   late String fontFamliy;
   late GradientColor gradientColor;
   ```

2. **DatabaseProvider** (`lib/db/database_provider.dart`)
   ```dart
   Database? _database;  // 改为可空，在初始化时赋值
   ```

3. **各种 Widget State 类**
   - 所有 `AnimationController` 字段使用 `late`
   - 所有 `PageController` 字段使用 `late`
   - 所有 `ScrollController` 字段使用 `late`

**示例**:
```dart
class _MyWidgetState extends State<MyWidget> {
  late AnimationController animationController;
  late PageController pageController;
  
  @override
  void initState() {
    super.initState();
    animationController = AnimationController(...);
    pageController = PageController();
  }
}
```

---

## 阶段七：其他修复

### 7.1 修复返回类型

**DatabaseProvider** (`lib/db/database_provider.dart`):
```dart
Future<User?> getCurrentUser() async {  // 返回可空
  // ...
  if (results.isEmpty) {
    return null;  // 现在允许返回 null
  }
  // ...
}

Future<Habit?> getHabitById(String id) async {  // 返回可空
  // ...
  if (results.isEmpty) {
    return null;
  }
  // ...
}
```

### 7.2 修复参数类型

**HabitEditPage** (`lib/add_habit/habit_edit_page.dart`):
```dart
Pair2<List<String>?, List<DateTime>> _updateHabit(Habit newHabit) {
  // ...
  if (newRemindTimes.length == 0) {
    return Pair2(null, remindTimes);  // 第一个参数可为 null
  }
  // ...
  return Pair2(['您更新了提醒时间', tips], remindTimes);
}
```

### 7.3 修复动画类型

多个文件中的 `Animation<dynamic>` 应改为 `Animation<double>`:
```dart
// 修复前
Animation<dynamic> animation;

// 修复后
Animation<double> animation;
```

---

## 执行顺序

1. ✅ **已完成**: 升级 SDK 版本和创建本地 alarm_plugin
2. ⏳ **下一步**: 升级第三方依赖包
3. ⏳ 修复核心模型类 (User, Habit)
4. ⏳ 修复 BLoC 相关代码
5. ⏳ 修复工具类和 Widget
6. ⏳ 修复字段初始化问题
7. ⏳ 运行 `flutter analyze` 检查所有错误
8. ⏳ 运行 `flutter test` 确保测试通过
9. ⏳ 在模拟器上测试运行

---

## 验证步骤

完成迁移后，执行以下命令验证：

```bash
# 1. 检查依赖
flutter pub get

# 2. 静态分析
flutter analyze

# 3. 运行测试
flutter test

# 4. 构建 iOS
flutter build ios --debug

# 5. 构建 Android
flutter build apk --debug

# 6. 运行应用
flutter run
```

---

## 注意事项

1. **备份代码**: 在开始迁移前，确保代码已提交到版本控制
2. **分阶段提交**: 每完成一个阶段就提交一次，方便回滚
3. **测试覆盖**: 修复每个文件后，立即测试相关功能
4. **文档更新**: 如有 API 变更，更新相关文档
5. **性能监控**: 迁移后监控应用性能，确保没有性能退化

---

## 预计工作量

- **阶段一 (依赖升级)**: 1-2 小时
- **阶段二 (核心模型)**: 2-3 小时
- **阶段三 (BLoC)**: 2-3 小时
- **阶段四 (工具类/Widget)**: 4-6 小时
- **阶段五 (第三方库)**: 1-2 小时
- **阶段六 (字段初始化)**: 2-3 小时
- **阶段七 (其他修复)**: 2-3 小时
- **测试和验证**: 2-3 小时

**总计**: 约 16-24 小时

---

## 参考资料

- [Dart 空安全迁移指南](https://dart.dev/null-safety/migration-guide)
- [Flutter 迁移指南](https://docs.flutter.dev/release/breaking-changes)
- [BLoC 8.0 迁移指南](https://bloclibrary.dev/#/migration)

---

**最后更新**: 2024年
**状态**: 进行中

